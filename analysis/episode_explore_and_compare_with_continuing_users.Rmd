---
title: "Population Exploration"
author:  "Mofi Islam and Dennis Wollersheim "
date: "2018-11-19 "
output:
  workflowr::wflow_html:
    toc: false
---

```{r pre_initial, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

rm(list=ls())
options(width = 200)
show_code = FALSE
source("lib/functions.R")
source("lib/standardisation.R")
source("lib/get_data.R")
source("lib/generate_data_frames.R")
source("lib/findOverlap.R")
library('tidyverse')
opts_chunk$set(echo = FALSE)

```


```{r initial, results='hide', message=FALSE, warning=FALSE}

dataset="_rr"
dataset=""
get_data_from_cache(dataset = dataset)
source('lib/findOverlap_simplified.R')


```


```{r get_continuing_users}

df_dd_overlap_all %>%
  count( pin ) %>%
  full_join ( df_patient_usage %>% 
             filter( drug_type == 'opioid')
           , by = 'pin' ) %>% 
  mutate( is_dd = ifelse( is.na(n), 'not_dd', 'dd') ) %>%
  { . } -> df_match


cat ('# number of users who do not double dip ')

df_match %>%
  count( is_dd ) 

cat ('# ratio of double dippers for each usage category')

df_match %>% 
  count( usage_category, is_dd) %>% 
  spread( is_dd, nn ) %>%
  mutate( ratio_dd = dd/not_dd )


df_match %>% 
  inner_join( df_patient ) %>%
  count( lga, usage_category, is_dd) %>% 
  spread( is_dd, nn ) %>%
  mutate( ratio_dd = dd/not_dd ) %>%
  filter( lga != '.' ) %>%
  group_by( usage_category ) %>%
  mutate( value = cut( rate, 
                    breaks=quantile( rate, probs=seq(0,1,1/3) ), 
                    labels=qc( low, medium, high ))
  ) %>%
  print_map( states_outline_map, title="ratio", filename='/tmp/a.png', inset_states=c(1,2,4:6 ) ) 
  


```

